#compdef p4
# ------------------------------------------------------------------------------
# Description
# -----------
#
#  Completion script for p4(http://www.perforce.com/)
#
# ------------------------------------------------------------------------------
# Authors
# -------
#
#  * zachwhaley (http://zachwhaley.me)
#
# ------------------------------------------------------------------------------

local -a global_opts
global_opts=(
  "-b[Specifies a batch size (number of arguments) to use when processing a command from a file with the -x argfile option. By default, the batch size is 128.]"
  "-c[Overrides any P4CLIENT setting with the specified client name.]"
  "-d[Overrides any PWD setting (current working directory) and replaces it with the specified directory.]"
  "-I[Specify that progress indicators, if available, are desired. This flag is not compatible with the -s and -G options.]"
  "-G[Causes all output (and batch input for form commands with -i) to be formatted as marshalled Python dictionary objects. This is most often used when scripting.]"
  "-H[Overrides any P4HOST setting and replaces it with the specified hostname.]"
  "-p[Overrides any P4PORT setting with the specified protocol:host:port.]"
  "-P[Overrides any P4PASSWD setting with the specified password.]"
  "-r[Specifies the number of times to retry a command (notably, p4 sync) if the network times out.]"
  "-s[Prepends a descriptive field (for example, text:, info:, error:, exit:) to each line of output produced by a Perforce command. This is most often used when scripting.]"
  "-u[Overrides any P4USER, USER, or USERNAME setting with the specified user name.]"
  "-x[Instructs Perforce to read arguments, one per line, from the specified file. If file is a single hyphen (-), then standard input is read.]"
  "-C[Overrides any P4CHARSET setting with the specified character set.]"
  "-Q[Overrides any P4COMMANDCHARSET setting with the specified character set.]"
  "-L[This feature is reserved for system integrators.]"
  "-z[Causes output of many reporting commands to be in the same tagged format as that generated by p4 fstat.]"
  "-q[Quiet mode; suppress all informational message and report only warnings or errors.]"
  "-V[Displays the version of the p4 application and exits.]"
  "-h[Displays basic usage information and exits.]"
)

local context state line curcontext="$curcontext"
local ret=1

typeset -A opt_args

_arguments -C \
  $global_opts \
  ':cmd:->cmds' \
  '*::arg:->args' \
&& ret=0

case "$state" in
  (cmds)
    local -a commands
    commands=(
      "add:Open a new file to add it to the depot"
      "annotate:Print file lines along with their revisions"
      "attribute:Set per-revision attributes on revisions"
      "branch:Create or edit a branch specification"
      "branches:Display list of branches"
      "change:Create or edit a changelist description"
      "changes:Display list of pending and submitted changelists"
      "changelist:Create or edit a changelist description"
      "changelists:Display list of pending and submitted changelists"
      "client:Create or edit a client specification and its view"
      "clients:Display list of known clients"
      "copy:Schedule copy of latest rev from one file to another"
      "counter:Display, set, or delete a counter"
      "counters:Display list of known counters"
      "cstat:Dump change/sync status for current client"
      "delete:Open an existing file to delete it from the depot"
      "depot:Create or edit a depot specification"
      "depots:Display list of depots"
      "describe:Display a changelist description"
      "diff:Display diff of client file with depot file"
      "diff2:Display diff of two depot files"
      "dirs:List subdirectories of a given depot directory"
      "edit:Open an existing file for edit"
      "filelog:List revision history of files"
      "files:List files in the depot"
      "fix:Mark jobs as being fixed by named changelists"
      "fixes:List what changelists fix what job"
      "flush:Fake a 'p4 sync' by not moving files"
      "fstat:Dump file info"
      "grep:Print lines from text files matching a pattern"
      "group:Change members of a user group"
      "groups:List groups (of users)"
      "have:List revisions last synced"
      "help:Print the requested help message"
      "info:Print out client/server information"
      "integrate:Schedule integration from one file to another"
      "integrated:Show integrations that have been submitted"
      "interchanges:Report changes that have not yet been integrated"
      "istat:Show integrations needed for a stream"
      "job:Create or edit a job (defect) specification"
      "jobs:Display list of jobs"
      "key:Display, set, or delete a key/value pair"
      "keys:Display list of known keys and their values"
      "label:Create or edit a label specification and its view"
      "labels:Display list of labels"
      "labelsync:Synchronize label with the current client contents"
      "list:Create an in-memory (label) list of depot files"
      "lock:Lock an opened file against changelist submission"
      "logger:Report what jobs and changelists have changed"
      "login:Login to Perforce by obtaining a session ticket"
      "logout:Logout of Perforce by removing or invalidating a ticket"
      "merge:Schedule merge (integration) from one file to another"
      "move:Moves files from one location to another"
      "opened:Display list of files opened for pending changelist"
      "passwd:Set the user's password on the server (and Windows client)"
      "populate:Populate a branch or stream with files"
      "print:Retrieve a depot file to the standard output"
      "protect:Modify protections in the server namespace"
      "protects:Display protections in place for a given user/path"
      "reconcile:Reconcile client to offline workspace changes"
      "rename:Moves files from one location to another"
      "reopen:Change the type or changelist number of an opened file"
      "resolve:Merge open files with other revisions or files"
      "resolved:Show files that have been merged but not submitted"
      "revert:Discard changes from an opened file"
      "review:List and track changelists (for the review daemon)"
      "reviews:Show what users are subscribed to review files"
      "set:Set variables in the registry (Windows only)"
      "shelve:Store files from a pending changelist into the depot"
      "status:Preview reconcile of client to offline workspace changes"
      "sizes:Display size information for files in the depot"
      "stream:Create or edit a stream specification"
      "streams:Display list of streams"
      "submit:Submit open files to the depot"
      "sync:Synchronize the client with its view of the depot"
      "tag:Tag files with a label"
      "tickets:Display list of session tickets for this user"
      "unlock:Release a locked file but leave it open"
      "unshelve:Restore shelved files from a pending changelist"
      "update:Update the client with its view of the depot"
      "user:Create or edit a user specification"
      "users:Display list of known users"
      "where:Show how file names map through the client view"
      "workspace:Create or edit a client specification and its view"
      "workspaces:Display list of known clients"
    )
    _describe -t commands 'p4 command' commands && ret=0
  ;;
  (args)
    case $words[1] in
      (add)
        _arguments -C \
          '-c[Opens the files for add within the specified changelist. If this flag is not used, the files are linked to the default changelist.]' \
          '-d[Downgrade file open status to simple add.]' \
          '-f[Use the -f flag to force inclusion of wildcards in filenames. See the File Specifications chapter for details.]' \
          '-I[Do not perform any ignore checking; ignore any settings specified by P4IGNORE.]' \
          '-n[Preview which files would be opened for add, without actually changing any files or metadata.]' \
          '-t[Adds the file as the specified filetype, overriding any settings in the typemap table.]' \
          '*: :_files' \
        && ret=0
      ;;
    esac
  ;;
esac

return ret

# Local Variables:
# mode: Shell-Script
# sh-indentation: 2
# indent-tabs-mode: nil
# sh-basic-offset: 2
# End:
# vim: ft=zsh sw=2 ts=2 et
